---
title: "IGC data"
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(DT)
library(tibble)
library(reshape2)
```

# Table to see log-likelihood 
```{r MakeTable, echo=FALSE}
col <- c("MG_ll", "MG_tau", "MG_Force_ll", "Difference")
difference <- MG["ll",] - MG_Forced["ll",]
MG_Force_Form <- data.frame(MG["ll",], MG["tau",], MG_Forced["ll",], difference) # Difference is the difference between MG_ll with and without force tau
datatable(MG_Force_Form, colnames = col) %>% 
  formatRound( columns = 1:4 , 3) %>% 
  formatStyle('difference', 
              background = styleColorBar(MG_Force_Form$difference, 'lightblue'), 
              backgroundSize = '98% 88%', 
              backgroundRepeat = 'no-repeat',
              backgroundPosition = 'center')
```
## Correlation of ll
```{r, ll}
qplot(MG["ll",], MG_Forced["ll",] ) + geom_abline(slope = 1, intercept = 0)
```

# Proportion of post-duplication changes due to IGC (ignore branches that do not have duplication)
### IGCchanges function $\frac{\sum{1->2}+\sum{2->1}}{\sum{1->2}+\sum{2->1}+\sum{mutation}}$
```{r}
IGCchanges <- function(a, b, mutation){
  num <- colSums(a) + colSums(b)
  den <- num + colSums(mutation)
  num/den
}
total <- IGCchanges(MG[c(44:57),], MG[c(60:73),], MG[c(76:89),]) %>% data.frame()
# 44:57 60:73 76:89
datatable(total, colnames = "proportion") %>%
  formatRound( columns = 1 , 3)  %>% 
  formatStyle('.', 
              background = styleColorBar(total$., 'lightblue'), 
              backgroundSize = '98% 88%', 
              backgroundRepeat = 'no-repeat',
              backgroundPosition = 'center')
```
## Calculate proportion for each branch separately.  Plot those (ignore N0-N1 and ignore N0-outgroup)
```{r}
IGCchangesSep <- function(x){
  one <- paste("(", x, ",1->2)",sep = "")
  two <- paste("(", x, ",2->1)",sep = "")
  mut <- paste("(", x, ",mut)",sep = "")
  num <- MG[one,] + MG[two,]
  den <- num + MG[mut,]
  num/den
}
N1N3 <- IGCchangesSep("N1,N3") 
N1N2 <- IGCchangesSep("N1,N2") 
N3N6 <- IGCchangesSep("N3,N6") 
N3N4 <- IGCchangesSep("N3,N4") 
N6N7 <- IGCchangesSep("N6,N7") 
N4N5 <- IGCchangesSep("N4,N5")
N2ENSDARG <- IGCchangesSep("N2,ENSDARG") 
N2ENSAMXG <- IGCchangesSep("N2,ENSAMXG") 
N6ENSGACG <- IGCchangesSep("N6,ENSGACG") 
N4ENSONIG <- IGCchangesSep("N4,ENSONIG") 
N7ENSTRUG <- IGCchangesSep("N7,ENSTRUG") 
N7ENSTNIG <- IGCchangesSep("N7,ENSTNIG") 
N5ENSXMAG <- IGCchangesSep("N5,ENSXMAG") 
N5ENSORLG <- IGCchangesSep("N5,ENSORLG") 
```

```{r}
IGC_List1 <- data.frame(N1N3, N1N2, N3N6, N3N4, N6N7, N4N5)
IGC_List2 <- data.frame(N2ENSDARG, N2ENSAMXG, N6ENSGACG, N4ENSONIG, N7ENSTRUG, N7ENSTNIG, N5ENSXMAG, N5ENSORLG) 

datatable(IGC_List1, colnames = c("N1N3", "N1N2", "N3N6", "N3N4", "N6N7", "N4N5")) %>% 
  formatRound( columns = 1:6 , 3) %>% 
  formatStyle(colnames(IGC_List1)[1:ncol(IGC_List1)],
              background = styleColorBar(IGC_List1$N1N3, 'lightblue'), 
              backgroundSize = '98% 88%', 
              backgroundRepeat = 'no-repeat',
              backgroundPosition = 'center')
datatable(IGC_List2, colnames = c("N2ENSDARG", "N2ENSAMXG", "N6ENSGACG", "N4ENSONIG", "N7ENSTRUG", "N7ENSTNIG", "N5ENSXMAG", "N5ENSORLG")) %>% 
  formatRound( columns = 1:8 , 3) %>% 
  formatStyle(colnames(IGC_List2)[1:ncol(IGC_List2)],
              background = styleColorBar(IGC_List2$N2ENSDARG, 'lightblue'), 
              backgroundSize = '98% 88%', 
              backgroundRepeat = 'no-repeat',
              backgroundPosition = 'center')

```
### Comparing between each branch
#### This part is the average of IGC rate for each branch.
```{r}
tpList <- data.frame(N1N3, N1N2, N3N6, N3N4, N2ENSDARG, N2ENSAMXG, N6N7, N6ENSGACG, N4N5, N4ENSONIG, N7ENSTRUG, N7ENSTNIG, N5ENSXMAG, N5ENSORLG) %>% t()
BranchIGCmean <- data.frame(rowMeans(tpList))
datatable(BranchIGCmean, colnames = "average") %>% 
  formatRound( columns = 1 , 3) %>% 
  formatStyle(colnames(BranchIGCmean)[1:ncol(BranchIGCmean)],
              background = styleColorBar(BranchIGCmean$rowMeans.tpList., 'lightblue'), 
              backgroundSize = '98% 88%', 
              backgroundRepeat = 'no-repeat',
              backgroundPosition = 'center')
```

```{r}
averageTau <- rowMeans(MG[28:41,]) %>% data.frame()
datatable(averageTau, colnames = "average") %>% 
  formatRound( columns = 1 , 3) %>% 
  formatStyle(colnames(averageTau)[1:ncol(averageTau)],
              background = styleColorBar(averageTau$., 'lightblue'), 
              backgroundSize = '98% 88%', 
              backgroundRepeat = 'no-repeat',
              backgroundPosition = 'center')
```

## Plot of each branch
```{r}
PlotBranch <- function(x){
  one <- paste("(", x, ",1->2)",sep = "")
  two <- paste("(", x, ",2->1)",sep = "")
  mut <- paste("(", x, ",mut)",sep = "")
  num <- MG[one,] + MG[two,]
  den <- num + MG[mut,]
  s <- lm(num~den-1)
  class(s)
  #print(s$coefficients[1])
  qplot(den, num) + 
    geom_abline(slope = s$coefficients[1], intercept = 0) + 
    ggtitle(label = x, subtitle = paste("slope:", toString(s$coefficients[1]), sep = " "))
}
PlotBranch("N1,N3")
PlotBranch("N1,N2")
PlotBranch("N3,N6")
PlotBranch("N3,N4")
PlotBranch("N2,ENSDARG")
PlotBranch("N2,ENSAMXG")
PlotBranch("N6,N7")
PlotBranch("N6,ENSGACG")
PlotBranch("N4,N5")
PlotBranch("N4,ENSONIG")
PlotBranch("N7,ENSTRUG")
PlotBranch("N7,ENSTNIG")
PlotBranch("N5,ENSXMAG")
PlotBranch("N5,ENSORLG")
```
# Asymmetry
## For this part we want to see if there's asymmetry between branch 1->2 and 2->1.
```{r}
Asymmetry <- function(x){
  one <- paste("(", x, ",1->2)",sep = "")
  two <- paste("(", x, ",2->1)",sep = "")
  qplot(MG[one,], MG[two,], main = x) + geom_abline(slope = 1, intercept = 0) +
    labs(x="1->2", y="2->1")
}
Asymmetry("N1,N3")
Asymmetry("N1,N2")
Asymmetry("N3,N6")
Asymmetry("N3,N4")
Asymmetry("N2,ENSDARG")
Asymmetry("N2,ENSAMXG")
Asymmetry("N6,N7")
Asymmetry("N6,ENSGACG")
Asymmetry("N4,N5")
Asymmetry("N4,ENSONIG")
Asymmetry("N7,ENSTRUG")
Asymmetry("N7,ENSTNIG")
Asymmetry("N5,ENSXMAG")
Asymmetry("N5,ENSORLG")
```

# Is estimated value of omega for a gene correlated with the estimated value of tau?
```{r MakePlot}
TMG <- t(MG)
ot <- lm(MG["omega",]~MG["tau",])$coefficients
pearson <- cor(MG["omega",], MG["tau",], method = "pearson")
qplot(MG["omega",], MG["tau",]) + 
  geom_abline(slope = ot[2], intercept = ot[1]) + 
  labs(title = "omega vs tau", x="omega", y="tau", subtitle = paste("pearson:", pearson, "\nslope:    ", ot))



summary(lm(MG["omega",]~MG["tau",]))

summary(aov(MG["omega",]~MG["tau",]))

```

# For tau using ANOVA method $Y = \alpha_i + \beta_j + \epsilon$ 
```{r}
MGstau <- MG[28:41,] %>% 
  #log10() %>% 
  data.frame() %>% 
  rownames_to_column(var = "branch")
MGstau
new <- melt(MGstau, id.vars = "branch", value.name = "tau")
colnames(new)[colnames(new) == "variable"] <- "gene"
new
A <- aov(data = new, formula = tau~branch+gene)    # A for ANOVA output
summary(A)
```

```{r}
library(lme4)
library(Matrix)
data <- data.frame(MG)
scale0 <- colSums(MG[c(44:57, 60:73),]) # sum of 1 -> 2 and 2 -> 1
tau.encount <- colSums(MG[c(44:57, 60:73),]) * MG[1,]
data <- rbind(MG, scale0, tau.encount)
data <- data[c(1, 8, 28:41, 90, 91),]
```


Poisson calculation
```{r}
taucountmatrix <- MG[44:57,]+MG[60:73,]
scale0matrix <- taucountmatrix/MG[28:41,]
omegamatrix <- rbind(MG[8,], MG[8,], MG[8,], MG[8,],MG[8,], MG[8,], MG[8,], MG[8,], MG[8,], MG[8,], MG[8,], MG[8,], MG[8,], MG[8,])
rownames(omegamatrix) <- rownames(MG[12:25,])
rownames(scale0matrix) <- rownames(MG[12:25,])
rownames(taucountmatrix) <- rownames(MG[12:25,])

newmatrix=matrix(rep(1,14*45),nrow=14)
for(i in 1:14){
  newmatrix[i,]=scale0matrix[i,]/MG[1,]
}
newmatrix=newmatrix/MG[12:25,]

genenamesmatrix <- rbind(colnames(taucountmatrix),colnames(taucountmatrix),colnames(taucountmatrix),colnames(taucountmatrix), colnames(taucountmatrix),colnames(taucountmatrix),colnames(taucountmatrix),colnames(taucountmatrix), colnames(taucountmatrix),colnames(taucountmatrix),colnames(taucountmatrix),colnames(taucountmatrix), colnames(taucountmatrix),colnames(taucountmatrix) )
branchnamesmatrix <- cbind(rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix), rownames(taucountmatrix))
taucountvector <- c(taucountmatrix)
scale0vector <- c(scale0matrix)
omegavector <- c(omegamatrix)
genenamesvector <- c(genenamesmatrix)
branchnamesvector <- c(branchnamesmatrix)

data=data.frame(IGCevent=taucountvector,scale0=log(scale0vector),omega=omegavector,genename=genenamesvector,
               branchname=branchnamesvector, seqdiff=c(newmatrix ))

library(lme4)
glm(round(IGCevent)~scale0+genename+seqdiff+seqdiff*genename,data=data,family = "poisson")
glm(IGCevent~scale0+branchname+genename,data=data,family = poisson)
```




















